# Facet.Search - Copilot Instructions

## Project Overview
Facet.Search is a compile-time faceted search generation library for .NET. It uses Roslyn source generators to automatically create search filter classes, LINQ extension methods, facet aggregations, and metadata from domain models.

## Repository Structure
- **src/Facet.Search/** — Core attributes and types (targets .NET Standard 2.0)
- **src/Facet.Search.Generators/** — Roslyn source generators for compile-time code generation
- **src/Facet.Search.EFCore/** — Entity Framework Core async extensions (targets .NET 10)
- **tests/Facet.Search.Tests/** — Unit tests for core functionality
- **tests/Facet.Search.EFCore.Tests/** — Integration tests for EF Core extensions
- **tests/Facet.Search.TestConsumer/** — Test consumer project for generator verification

## Build & Runtime Commands
- `dotnet build` or `dotnet build Facet.Search.sln` — Compiles the entire solution
- `dotnet test` — Runs all tests in the test projects
- `dotnet test --filter "FullyQualifiedName~{TestCategory}"` — Runs specific test category
- `dotnet pack` — Creates NuGet packages for distribution
- `dotnet build --no-incremental` — Clean build (useful when generator changes aren't being picked up)

**Important**: Source generators cache aggressively. If changes to generators aren't reflected:
1. Clean the solution: `dotnet clean`
2. Delete `obj/` and `bin/` directories
3. Rebuild with `dotnet build --no-incremental`

## Architecture Patterns

### Source Generator Structure (src/Facet.Search.Generators/)
All generators follow Roslyn's incremental generator pattern:

- **FacetSearchGenerator.cs** — Main generator entry point
- **Generators/** — Individual generator implementations:
  - `FilterClassGenerator.cs` — Generates `{Model}SearchFilter` classes
  - `ExtensionMethodsGenerator.cs` — Generates LINQ extension methods
  - `AggregationGenerator.cs` — Generates facet aggregation classes
  - `MetadataGenerator.cs` — Generates metadata for UI consumption
- **Models/** — Data models for generator processing

**Key Principles**:
- Use incremental generators (`IIncrementalGenerator`) for performance
- Generators must be deterministic and stateless
- Use `ForAttributeWithMetadataName` for attribute-based discovery
- Always handle `CancellationToken` to support incremental compilation
- Generated code should include `#nullable enable` directive
- Use `<auto-generated>` header in all generated files
- Never throw exceptions in generators — swallow and return null instead

### Generator Hint Names
- Hint names (file names passed to `context.AddSource()`) **cannot contain** invalid filename characters like `:`, `<`, `>`, `|`, etc.
- For types in global namespace, strip the `global::` prefix before building hint names

### Attributes (src/Facet.Search/)
- `[FacetedSearch]` — Marks a class for search generation
- `[SearchFacet]` — Marks a property as a filterable facet
- `[FullTextSearch]` — Marks a property for full-text search
- `[Searchable]` — Marks a property as searchable but not a facet

### EF Core Integration (src/Facet.Search.EFCore/)
- Use `IQueryable<T>` extensions for database operations
- Async methods: `ExecuteSearchAsync()`, `ToPagedResultAsync()`, `AggregateFacetAsync()`
- Pagination: `Paginate()`, `SortBy()`, `ThenSortBy()`

## Code Conventions

### C# Style
- **Namespace style**: File-scoped namespaces (`namespace Facet.Search.Generators;`)
- **Indentation**: 4 spaces (no tabs)
- **Naming**:
  - PascalCase for public APIs, types, properties, methods
  - `_camelCase` for private fields
  - `camelCase` for local variables and parameters
- **Null handling**: Use nullable reference types (`#nullable enable`)

### Generated Code
- Always include `// <auto-generated/>` header
- Include `#nullable enable` directive
- Use file-scoped namespaces
- Include XML documentation for public APIs

## Pull Request Guidelines
1. Create a branch from `master`
2. Write clear description of changes
3. Include test results (all tests must pass)
4. Update documentation if adding new features
5. Ensure no breaking changes unless major version bump

## Key Design Principles

### 1. Zero Runtime Cost
All code generation happens at compile time. Generated code should be as efficient as hand-written code.

### 2. Type Safety
Leverage C#'s type system. No reflection at runtime.

### 3. Developer Experience
- Intuitive attribute-based API
- Rich IntelliSense support
- Clear error messages via diagnostics
- Comprehensive XML documentation

### 4. Compatibility
- Support .NET Standard 2.0 for Facet.Search (attributes + bundled generator)
- Support .NET 10+ for Facet.Search.EFCore

### 5. Performance
- Incremental generators for fast compilation
- Efficient LINQ expressions for filtering

## Common Pitfalls

### Source Generator Development
- **Forgetting to handle global namespace**: Always check for and strip `global::` prefix
- **Invalid hint names**: Sanitize type names before using as file names
- **Non-deterministic generation**: Ensure generators produce same output for same input
- **Ignoring cancellation tokens**: Always pass and check `CancellationToken`
- **Throwing exceptions**: Swallow exceptions and return null or emit diagnostics

### Testing
- **Missing global namespace tests**: Always test classes with and without namespaces
- **Forgetting edge cases**: Test nullable types, collections, nested objects, etc.
- **Not verifying generated code**: Check `obj/Generated/` to ensure correct output

## Quick Reference

### Adding a New Generator Feature
1. Update or create the generator in `src/Facet.Search.Generators/Generators/`
2. Update models in `src/Facet.Search.Generators/Models/` if needed
3. Add test entities to `tests/Facet.Search.Tests/`
4. Create comprehensive tests
5. Verify generated code in `obj/Generated/`
6. Update documentation and examples

### Debugging Generator Issues
1. Check `obj/Generated/Facet.Search.Generators/` for generated files
2. Use `dotnet build --no-incremental` to force regeneration
3. Add test case to reproduce issue
4. Verify hint names don't contain invalid characters
5. Check for proper null handling and cancellation token usage

### Before Committing
- [ ] All tests pass (`dotnet test`)
- [ ] Code follows conventions (file-scoped namespaces, XML docs, etc.)
- [ ] Added tests for new features or bug fixes
- [ ] Updated documentation if needed
- [ ] Verified generated code quality
- [ ] No breaking changes (or documented if necessary)

## NuGet Packages

| Package | Description |
|---------|-------------|
| `Facet.Search` | Core attributes + bundled source generator |
| `Facet.Search.Generators` | Standalone source generator (dev dependency) |
| `Facet.Search.EFCore` | Entity Framework Core async extensions |

## References

- [Roslyn Source Generators Cookbook](https://github.com/dotnet/roslyn/blob/main/docs/features/source-generators.cookbook.md)
- [Incremental Generators](https://github.com/dotnet/roslyn/blob/main/docs/features/incremental-generators.md)
- [C# Coding Conventions](https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/coding-style/coding-conventions)
